= Bruno Run Report
// ############################################################
// ATTENTION!
// ----------
// Do not edit the README.adoc file. It is generated from the sources
// located in the /docs folder. The root file for the documentation is
// /docs/index.adoc
// ############################################################
:toc: macro
:icons: font
ifdef::env-github[]
:tip-caption: :bulb:
:note-caption: :information_source:
:important-caption: :heavy_exclamation_mark:
:caution-caption: :fire:
:warning-caption: :warning:
endif::[]
:action-badge-ci: https://github.com/krummbar/bruno-run-report/actions/workflows/ci.yml/badge.svg
:action-badge-lint: https://github.com/krummbar/bruno-run-report/actions/workflows/linter.yml/badge.svg
:url-bruno-run-action: https://github.com/krummbar/bruno-run-action
:url-bruno-cli: https://www.npmjs.com/package/@usebruno/cli

:url-action-ci: https://github.com/krummbar/bruno-run-report/actions/workflows/ci.yml
:url-action-lint: https://github.com/krummbar/bruno-run-report/actions/workflows/linter.yml

image:{action-badge-ci}[Continuous Integration,link={url-action-ci}]
image:{action-badge-lint}[Lint Codebase,link={url-action-lint}]

A GitHub Action attaching a Markdown summary to a {url-bruno-cli}[`bru cli run`] execution parsed from a JSON result.
This can be a subsequent step to {url-bruno-run-action}[bruno-run-action] to render a test run summary.

[WARNING]
====
Supports JSON reports generated by bru cli v1.20.0
====

Examples of the final summary attached to the job can be found here:

* xref:docs/attachments/report-failure-result.md[]
* xref:docs/attachments/report-result.md[]

toc::[]

:leveloffset: 1

= Usage
:url-gha-continue-on-error: https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#jobsjob_idstepscontinue-on-error

The listed example clones a repository source, executes the `bru run` command,
and finally attaches a markdown summary at the end from the previous run.

.Attach run summary
[source,yaml]
----
name: Bruno Test & Report

on:
  workflow_dispatch:

jobs:
  bruno-tests:
    name: Bruno test collection
    runs-on: ubuntu-latest
    steps:
      - name: Checkout  # <1>
        id: checkout
        uses: actions/checkout@v4

      - name: Bruno CLI runner  # <2>
        id: bru-cli
        uses: krummbar/bruno-run-action@main
        with:
          path: bruno/api-it
          output: bru-output.json # <3>
          outputFormat: json

      - name: Attach bru run summary # <4>
        uses: krummbar/bruno-run-report@main
        continue-on-error: true # <5>
        with:
          run-report-path: bru-output.json # <6>
----
<1> Clone repository
<2> Execute `bru run` with a collection located in folder `bruno/api-it`
<3> Specify the report result summary in *JSON* format
<4> Generates the Markdown summary and attaches it to `${GITHUB_SUMMARY}`
<5> *Optional* make report step succeed even though report step potentially fails, {url-gha-continue-on-error}[see documentation]
<6> Needs to match the path listed in callout *3*`

== Inputs

[source,yaml]
----
run-report-path:
  description: Path of the bru run execution summary.
  required: true
output-path:
  description: If provided the contents of the markdown report will be written to the given path.
  required: false
include-footer:
  description: En- or disable the report footer.
  required: false
  default: 'true'
include-report-sources:
  description: If enabled, each suite includes the raw JSON details of the run result.
  required: false
  default: 'false'
only-failed:
  description: Skips successful testsuites in the report if set true.
  required: false
  default: 'false'
report-title:
  description: Set a custom title for the report.
  required: false
  default: Bruno Run
----

== Outputs

[source,yaml]
----
success:
  description: Indicates test run success status.
md-report-path:
  description: The contents of the markdown file.
----

:leveloffset!:

:leveloffset: 1

= Development
:url-asciidoctor: https://docs.asciidoctor.org/asciidoc/latest/
:url-asciidoctor-reducer: https://github.com/asciidoctor/asciidoctor-reducer
:url-jq: https://jqlang.github.io/jq/

== Test Locally

In order to execute the actual script the action's input parameters must be set as environment variables,
and `jq` needs to be available on the work station.

Prerequisites::
* {url-jq}[jq]

The required input parameters are listed in xref:docs/examples/.env.sample[].

[source,sh]
----
IN_REPORT_TITLE="Bruno Run"
IN_INCLUDE_FOOTER=true
IN_INCLUDE_REPORT_SOURCES=false
IN_ONLY_FAILED=false
# IN_OUTPUT_PATH=docs/examples/report-result.md
IN_RUN_REPORT_PATH=.github/bru-run-results/bru-output.json
GITHUB_OUTPUT=out/github-out.log
GITHUB_STEP_SUMMARY=out/github-step-summary.md
----

If the environment variables are set according to your needs, the main script can simply be executed.

[source,console]
----
./entrypoint.sh
----

[IMPORTANT]
====
If the above listed values are used, ensure the `out` folder exists and the project's root folder.
Otherwise the script execution may fail.
====

The markdown result is dumped to the configured path in `GITHUB_STEP_SUMMARY`, and if set copied to `IN_OUTPUT_PATH`

=== Explanation

The script uses `jq` to read the JSON report of a bru run process and markdown templates for generic information as the optional footer.
The transform functions and templates are defined in the xref:src[] folder.


== Documentation

The `README.adoc` file is generated from the sources in the link:docs[docs] folder.
Any documentation changes must be applied to the files located in there.

Prerequisites::
* {url-asciidoctor}[AsciiDoc]
* {url-asciidoctor-reducer}[AsciiDoctor Reducer]

In order to update the contents of the `README.adoc` run the following command.

.Update README.adoc
[source,console]
----
asciidoctor-reducer --preserve-conditionals -o README.adoc docs/index.adoc
----


:leveloffset!:
